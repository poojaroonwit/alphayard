// ============================================================================
// BOUNDARY DATABASE - PRISMA SCHEMA
// ============================================================================
// 
// 3-Schema Structure:
//   - core: Global data + common features (users, files, notifications)
//   - admin: Admin panel only (admin users, roles, permissions)
//   - bondarys: Bondarys app specific (social, circles, chat, location)
//
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "core", "admin", "bondarys"]
}


// ####################################################################################
//
//                              CORE SCHEMA
//                     (Global + Common Features)
//
// ####################################################################################

// ============================================================================
// CORE: Applications
// ============================================================================

model Application {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  description String?  @db.Text
  logoUrl     String?  @map("logo_url") @db.Text
  branding    Json     @default("{}")
  settings    Json     @default("{}")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  userApplications      UserApplication[]
  adminUserApplications AdminUserApplication[]
  userSessions          UserSession[]
  userDevices           UserDevice[]
  loginHistory          LoginHistory[]
  userSettings          UserSettings[]
  files                 File[]
  fileFolders           FileFolder[]
  galleryItems          GalleryItem[]
  galleryAlbums         GalleryAlbum[]
  notifications         Notification[]
  userPushTokens        UserPushToken[]
  emailTemplates        EmailTemplate[]
  subscriptionPlans     SubscriptionPlan[]
  subscriptions         Subscription[]
  appSettings           AppSetting[]
  adminActivityLogs     AdminActivityLog[]
  auditLogs             AuditLog[]
  oauthProviders        OAuthProvider[]
  securityPolicies      SecurityPolicy[]
  oauthClients          OAuthClient[]
  userGroups            UserGroup[]

  @@map("applications")
  @@schema("core")
}

// ============================================================================
// CORE: Users
// ============================================================================

model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  firstName    String    @map("first_name") @db.VarChar(100)
  lastName     String    @map("last_name") @db.VarChar(100)
  phoneNumber  String?   @map("phone_number") @db.VarChar(20)
  avatarUrl    String?   @map("avatar_url") @db.Text
  dateOfBirth  DateTime? @map("date_of_birth") @db.Date
  gender       String?   @db.VarChar(20)
  bio          String?   @db.Text
  userType     String    @default("user") @map("user_type") @db.VarChar(50)
  preferences  Json      @default("{}")
  isActive     Boolean   @default(true) @map("is_active")
  isVerified   Boolean   @default(false) @map("is_verified")
  verifiedAt   DateTime? @map("verified_at") @db.Timestamptz
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamptz
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  userApplications   UserApplication[]
  userSessions       UserSession[]
  userDevices        UserDevice[]
  loginHistory       LoginHistory[]
  userSettings       UserSettings[]
  files              File[]
  fileFolders        FileFolder[]
  galleryItems       GalleryItem[]
  galleryAlbums      GalleryAlbum[]
  notifications      Notification[]
  userPushTokens     UserPushToken[]
  subscriptions      Subscription[]
  userMFA            UserMFA[]
  userGroupMembers   UserGroupMember[]

  @@index([email])
  @@index([isActive])
  @@index([phoneNumber])
  @@map("users")
  @@schema("core")
}

// ============================================================================
// CORE: User Applications (Junction)
// ============================================================================

model UserApplication {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  applicationId String    @map("application_id") @db.Uuid
  role          String    @default("member") @db.VarChar(50)
  status        String    @default("active") @db.VarChar(50)
  settings      Json      @default("{}")
  joinedAt      DateTime  @default(now()) @map("joined_at") @db.Timestamptz
  lastActiveAt  DateTime? @map("last_active_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([userId, applicationId])
  @@index([userId])
  @@index([applicationId])
  @@map("user_applications")
  @@schema("core")
}

// ============================================================================
// CORE: Reference Data
// ============================================================================

model Country {
  id           String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String  @unique @db.VarChar(3)
  name         String  @db.VarChar(100)
  nativeName   String? @map("native_name") @db.VarChar(100)
  phoneCode    String? @map("phone_code") @db.VarChar(10)
  currencyCode String? @map("currency_code") @db.VarChar(3)
  flagEmoji    String? @map("flag_emoji") @db.VarChar(10)
  isActive     Boolean @default(true) @map("is_active")

  @@map("countries")
  @@schema("core")
}

model Language {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String  @unique @db.VarChar(10)
  name       String  @db.VarChar(100)
  nativeName String? @map("native_name") @db.VarChar(100)
  direction  String  @default("ltr") @db.VarChar(3)
  isActive   Boolean @default(true) @map("is_active")

  @@map("languages")
  @@schema("core")
}

model Currency {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code          String  @unique @db.VarChar(3)
  name          String  @db.VarChar(100)
  symbol        String? @db.VarChar(10)
  decimalPlaces Int     @default(2) @map("decimal_places")
  isActive      Boolean @default(true) @map("is_active")

  @@map("currencies")
  @@schema("core")
}

// ============================================================================
// CORE: Sessions & Devices
// ============================================================================

model UserSession {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  applicationId  String?   @map("application_id") @db.Uuid
  sessionToken   String?   @map("session_token") @db.VarChar(255)
  refreshToken   String?   @map("refresh_token") @db.VarChar(255)
  tokenHash      String?    @map("token_hash") @db.VarChar(255)
  deviceId       String?   @map("device_id") @db.Uuid
  deviceType     String?   @map("device_type") @db.VarChar(50)
  deviceName     String?   @map("device_name") @db.VarChar(255)
  browser        String?   @db.VarChar(50)
  browserVersion String?   @map("browser_version") @db.VarChar(50)
  os             String?   @db.VarChar(50)
  osVersion     String?   @map("os_version") @db.VarChar(50)
  ipAddress      String?   @map("ip_address") @db.Inet
  country        String?   @db.VarChar(100)
  city           String?   @db.VarChar(100)
  isActive       Boolean   @default(true) @map("is_active")
  isRemembered   Boolean   @default(false) @map("is_remembered")
  mfaVerified    Boolean   @default(false) @map("mfa_verified")
  riskScore      Int       @default(0) @map("risk_score")
  lastActivityAt DateTime  @default(now()) @map("last_activity_at") @db.Timestamptz
  expiresAt      DateTime  @map("expires_at") @db.Timestamptz
  revokedAt      DateTime? @map("revoked_at") @db.Timestamptz
  revokedBy      String?   @map("revoked_by") @db.Uuid
  revokeReason   String?   @map("revoke_reason") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sessionToken])
  @@index([refreshToken])
  @@map("user_sessions")
  @@schema("core")
}

model UserDevice {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  applicationId   String?   @map("application_id") @db.Uuid
  deviceFingerprint String? @map("device_fingerprint") @db.VarChar(255)
  deviceName      String?   @map("device_name") @db.VarChar(255)
  deviceType      String?   @map("device_type") @db.VarChar(50)
  brand           String?   @db.VarChar(50)
  model           String?   @db.VarChar(50)
  os              String?   @db.VarChar(50)
  osVersion       String?   @map("os_version") @db.VarChar(50)
  browser         String?   @db.VarChar(50)
  browserVersion  String?   @map("browser_version") @db.VarChar(50)
  pushToken       String?   @map("push_token") @db.Text
  pushEnabled     Boolean   @default(false) @map("push_enabled")
  isTrusted       Boolean   @default(false) @map("is_trusted")
  isCurrent       Boolean   @default(false) @map("is_current")
  trustLevel      Int       @default(1) @map("trust_level")
  firstSeenAt     DateTime  @default(now()) @map("first_seen_at") @db.Timestamptz
  lastSeenAt      DateTime  @default(now()) @map("last_seen_at") @db.Timestamptz
  lastIpAddress   String?   @map("last_ip_address") @db.VarChar(50)
  lastLocationCountry String? @map("last_location_country") @db.VarChar(100)
  lastLocationCity    String? @map("last_location_city") @db.VarChar(100)
  loginCount      Int       @default(0) @map("login_count")
  failedLoginCount Int      @default(0) @map("failed_login_count")
  isActive        Boolean   @default(true) @map("is_active")
  isBlocked       Boolean   @default(false) @map("is_blocked")
  blockedAt       DateTime? @map("blocked_at") @db.Timestamptz
  blockedReason   String?   @map("blocked_reason") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([deviceFingerprint])
  @@map("user_devices")
  @@schema("core")
}

model UserMFA {
  id                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                  String    @map("user_id") @db.Uuid
  mfaType                 String    @map("mfa_type") @db.VarChar(50)
  isEnabled               Boolean   @default(false) @map("is_enabled")
  isPrimary               Boolean   @default(false) @map("is_primary")
  totpSecret              String?   @map("totp_secret") @db.Text
  totpVerifiedAt          DateTime? @map("totp_verified_at") @db.Timestamptz
  phoneNumber             String?   @map("phone_number") @db.VarChar(20)
  email                   String?   @db.VarChar(255)
  backupCodes             Json?     @map("backup_codes")
  backupCodesGeneratedAt  DateTime? @map("backup_codes_generated_at") @db.Timestamptz
  backupCodesUsed         Int       @default(0) @map("backup_codes_used")
  lastUsedAt              DateTime? @map("last_used_at") @db.Timestamptz
  useCount                Int       @default(0) @map("use_count")
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, mfaType])
  @@index([userId])
  @@map("user_mfa")
  @@schema("core")
}

model SecurityPolicy {
  id                      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId           String?  @map("application_id") @db.Uuid
  policyName              String   @map("policy_name") @db.VarChar(100)
  policyType              String   @default("default") @map("policy_type") @db.VarChar(50)
  isActive                Boolean  @default(true) @map("is_active")
  priority                Int      @default(0)
  passwordMinLength      Int      @default(8) @map("password_min_length")
  passwordMaxLength      Int      @default(128) @map("password_max_length")
  passwordRequireUppercase Boolean  @default(true) @map("password_require_uppercase")
  passwordRequireLowercase Boolean  @default(true) @map("password_require_lowercase")
  passwordRequireNumber    Boolean  @default(true) @map("password_require_number")
  passwordRequireSpecial   Boolean  @default(true) @map("password_require_special")
  passwordHistoryCount    Int      @default(5) @map("password_history_count")
  passwordExpiryDays       Int      @default(90) @map("password_expiry_days")
  lockoutEnabled           Boolean  @default(true) @map("lockout_enabled")
  lockoutThreshold         Int      @default(5) @map("lockout_threshold")
  lockoutDurationMinutes   Int      @default(30) @map("lockout_duration_minutes")
  lockoutResetAfterMinutes Int      @default(30) @map("lockout_reset_after_minutes")
  sessionTimeoutMinutes    Int      @default(1440) @map("session_timeout_minutes")
  sessionMaxConcurrent     Int      @default(5) @map("session_max_concurrent")
  mfaRequired              Boolean  @default(false) @map("mfa_required")
  mfaRequiredForRoles     String[] @default([]) @map("mfa_required_for_roles")
  mfaRememberDeviceDays    Int      @default(30) @map("mfa_remember_device_days")
  mfaAllowedTypes         String[] @default(["totp"]) @map("mfa_allowed_types")
  ipWhitelist             String[] @default([]) @map("ip_whitelist")
  ipBlacklist             String[] @default([]) @map("ip_blacklist")
  ipGeoWhitelist          String[] @default([]) @map("ip_geo_whitelist")
  ipGeoBlacklist          String[] @default([]) @map("ip_geo_blacklist")
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([applicationId])
  @@map("security_policies")
  @@schema("core")
}

model UserGroup {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId   String?  @map("application_id") @db.Uuid
  name            String   @db.VarChar(100)
  slug            String   @unique @db.VarChar(100)
  description     String?  @db.Text
  roleId          String?  @map("role_id") @db.Uuid
  permissions     Json     @default("[]")
  isSystem        Boolean  @default(false) @map("is_system")
  isDefault       Boolean  @default(false) @map("is_default")
  metadata        Json     @default("{}")
  color           String?  @db.VarChar(20)
  icon            String?  @db.VarChar(50)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  members     UserGroupMember[]

  @@index([applicationId])
  @@map("user_groups")
  @@schema("core")
}

model UserGroupMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @default("member") @db.VarChar(20)
  addedBy   String?  @map("added_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  group UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("user_group_members")
  @@schema("core")
}

model IdentityAuditLog {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actorType       String   @map("actor_type") @db.VarChar(50)
  actorId         String?  @map("actor_id") @db.Uuid
  actorEmail      String?  @map("actor_email") @db.VarChar(255)
  targetType      String   @map("target_type") @db.VarChar(50)
  targetId        String?  @map("target_id") @db.Uuid
  targetEmail     String?  @map("target_email") @db.VarChar(255)
  action          String   @db.VarChar(100)
  actionCategory  String?  @map("action_category") @db.VarChar(50)
  description     String?  @db.Text
  oldValue        Json?    @map("old_value")
  newValue        Json?    @map("new_value")
  metadata        Json?
  ipAddress       String?  @map("ip_address") @db.VarChar(50)
  userAgent       String?  @map("user_agent") @db.Text
  deviceId        String?  @map("device_id") @db.Uuid
  sessionId       String?  @map("session_id") @db.Uuid
  status          String   @default("success") @db.VarChar(20)
  errorMessage    String?  @map("error_message") @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([actorId])
  @@index([targetId])
  @@index([action])
  @@index([createdAt])
  @@map("identity_audit_log")
  @@schema("core")
}

model OAuthProvider {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId        String?  @map("application_id") @db.Uuid
  providerName         String   @map("provider_name") @db.VarChar(50)
  displayName          String   @map("display_name") @db.VarChar(100)
  isEnabled            Boolean  @default(true) @map("is_enabled")
  clientId             String   @map("client_id") @db.Text
  clientSecret         String   @map("client_secret") @db.Text
  authorizationUrl     String?  @map("authorization_url") @db.Text
  tokenUrl             String?  @map("token_url") @db.Text
  userinfoUrl          String?  @map("userinfo_url") @db.Text
  scopes               Json     @default("[]")
  claimsMapping        Json     @default("{}") @map("claims_mapping")
  allowSignup          Boolean  @default(true) @map("allow_signup")
  requireEmailVerified Boolean  @default(true) @map("require_email_verified")
  autoLinkByEmail      Boolean  @default(false) @map("auto_link_by_email")
  iconUrl              String?  @map("icon_url") @db.Text
  buttonColor          String?  @map("button_color") @db.VarChar(20)
  buttonText           String?  @map("button_text") @db.VarChar(50)
  jwksUrl              String?  @map("jwks_url") @db.Text
  allowedDomains       String[] @default([]) @map("allowed_domains")
  defaultRole          String?  @map("default_role") @db.VarChar(50)
  displayOrder         Int      @default(0) @map("display_order")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([applicationId])
  @@map("oauth_providers")
  @@schema("core")
}

model LoginHistory {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  applicationId   String?  @map("application_id") @db.Uuid
  email           String?  @db.VarChar(255)
  username        String?  @db.VarChar(100)
  loginMethod     String?  @map("login_method") @db.VarChar(50)
  socialProvider  String?  @map("social_provider") @db.VarChar(50)
  success         Boolean  @default(true)
  failureReason   String?  @map("failure_reason") @db.Text
  ipAddress       String?  @map("ip_address") @db.Inet
  userAgent       String?  @map("user_agent") @db.Text
  deviceType      String?  @map("device_type") @db.VarChar(50)
  deviceId        String?  @map("device_id") @db.Uuid
  country         String?  @db.VarChar(100)
  city            String?  @db.VarChar(100)
  mfaRequired     Boolean  @default(false) @map("mfa_required")
  mfaMethod       String?  @map("mfa_method") @db.VarChar(50)
  mfaSuccess      Boolean? @map("mfa_success")
  riskScore       Int      @default(0) @map("risk_score")
  isSuspicious    Boolean  @default(false) @map("is_suspicious")
  suspiciousReason String? @map("suspicious_reason") @db.Text
  sessionId       String?  @map("session_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@map("login_history")
  @@schema("core")
}

// ============================================================================
// CORE: User Settings
// ============================================================================

model UserSettings {
  id                      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                  String   @map("user_id") @db.Uuid
  applicationId           String?  @map("application_id") @db.Uuid
  languageCode            String   @default("en") @map("language_code") @db.VarChar(10)
  timezone                String   @default("UTC") @db.VarChar(50)
  theme                   String   @default("system") @db.VarChar(20)
  notificationPreferences Json     @default("{}") @map("notification_preferences")
  privacySettings         Json     @default("{}") @map("privacy_settings")
  settings                Json     @default("{}")
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@unique([userId, applicationId])
  @@map("user_settings")
  @@schema("core")
}

// ============================================================================
// CORE: Files & Storage
// ============================================================================

model File {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  applicationId   String?  @map("application_id") @db.Uuid
  folderId        String?  @map("folder_id") @db.Uuid
  filename        String   @db.VarChar(255)
  originalFilename String? @map("original_filename") @db.VarChar(255)
  mimeType        String?  @map("mime_type") @db.VarChar(100)
  fileSize        BigInt?  @map("file_size")
  storagePath     String   @map("storage_path") @db.Text
  storageProvider String   @default("local") @map("storage_provider") @db.VarChar(50)
  url             String?  @db.Text
  thumbnailUrl    String?  @map("thumbnail_url") @db.Text
  metadata        Json     @default("{}")
  isPublic        Boolean  @default(false) @map("is_public")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  folder      FileFolder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)
  galleryItem GalleryItem?

  @@index([userId])
  @@index([applicationId])
  @@index([folderId])
  @@index([mimeType])
  @@map("files")
  @@schema("core")
}

model FileFolder {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  parentId      String?  @map("parent_id") @db.Uuid
  name          String   @db.VarChar(255)
  color         String?  @db.VarChar(20)
  icon          String?  @db.VarChar(50)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  parent      FileFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    FileFolder[] @relation("FolderHierarchy")
  files       File[]

  @@map("file_folders")
  @@schema("core")
}

model GalleryItem {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  applicationId String?   @map("application_id") @db.Uuid
  fileId        String?   @unique @map("file_id") @db.Uuid
  albumId       String?   @map("album_id") @db.Uuid
  caption       String?   @db.Text
  locationName  String?   @map("location_name") @db.VarChar(255)
  latitude      Decimal?  @db.Decimal(10, 8)
  longitude     Decimal?  @db.Decimal(11, 8)
  takenAt       DateTime? @map("taken_at") @db.Timestamptz
  isFavorite    Boolean   @default(false) @map("is_favorite")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application?  @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  file        File?         @relation(fields: [fileId], references: [id], onDelete: Cascade)
  album       GalleryAlbum? @relation(fields: [albumId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([albumId])
  @@map("gallery_items")
  @@schema("core")
}

model GalleryAlbum {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  name          String   @db.VarChar(255)
  description   String?  @db.Text
  coverImageId  String?  @map("cover_image_id") @db.Uuid
  isPrivate     Boolean  @default(false) @map("is_private")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application?  @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  items       GalleryItem[]

  @@map("gallery_albums")
  @@schema("core")
}

// ============================================================================
// CORE: Notifications
// ============================================================================

model Notification {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  applicationId String?   @map("application_id") @db.Uuid
  type          String    @db.VarChar(50)
  title         String?   @db.VarChar(255)
  body          String?   @db.Text
  data          Json      @default("{}")
  imageUrl      String?   @map("image_url") @db.Text
  actionUrl     String?   @map("action_url") @db.Text
  isRead        Boolean   @default(false) @map("is_read")
  readAt        DateTime? @map("read_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([applicationId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
  @@schema("core")
}

model UserPushToken {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  token         String   @db.Text
  platform      String   @db.VarChar(20)
  deviceId      String?  @map("device_id") @db.VarChar(255)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@unique([token])
  @@index([userId])
  @@map("user_push_tokens")
  @@schema("core")
}

// ============================================================================
// CORE: Email Templates
// ============================================================================

model EmailTemplate {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  name          String   @db.VarChar(100)
  slug          String   @db.VarChar(100)
  subject       String   @db.VarChar(255)
  htmlContent   String?  @map("html_content") @db.Text
  textContent   String?  @map("text_content") @db.Text
  variables     Json     @default("[]")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@unique([applicationId, slug])
  @@map("email_templates")
  @@schema("core")
}

// ============================================================================
// CORE: Subscriptions & Billing
// ============================================================================

model SubscriptionPlan {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  name          String   @db.VarChar(100)
  slug          String   @db.VarChar(100)
  description   String?  @db.Text
  priceMonthly  Decimal? @map("price_monthly") @db.Decimal(10, 2)
  priceYearly   Decimal? @map("price_yearly") @db.Decimal(10, 2)
  currency      String   @default("USD") @db.VarChar(3)
  features      Json     @default("[]")
  limits        Json     @default("{}")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  application   Application?   @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  subscriptions Subscription[]

  @@map("subscription_plans")
  @@schema("core")
}

model Subscription {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  applicationId      String?   @map("application_id") @db.Uuid
  planId             String?   @map("plan_id") @db.Uuid
  status             String    @default("active") @db.VarChar(50)
  billingCycle       String    @default("monthly") @map("billing_cycle") @db.VarChar(20)
  currentPeriodStart DateTime? @map("current_period_start") @db.Timestamptz
  currentPeriodEnd   DateTime? @map("current_period_end") @db.Timestamptz
  canceledAt         DateTime? @map("canceled_at") @db.Timestamptz
  externalId         String?   @map("external_id") @db.VarChar(255)
  metadata           Json      @default("{}")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application?      @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  plan        SubscriptionPlan? @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
  @@schema("core")
}

// ============================================================================
// CORE: System Config
// ============================================================================

model SystemConfig {
  key         String   @id @db.VarChar(255)
  value       Json
  description String?  @db.Text
  isPublic    Boolean  @default(false) @map("is_public")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("system_config")
  @@schema("core")
}

model AppSetting {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String   @map("application_id") @db.Uuid
  key           String   @db.VarChar(255)
  value         Json
  description   String?  @db.Text
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([applicationId, key])
  @@map("app_settings")
  @@schema("core")
}

// ####################################################################################
//
//                              ADMIN SCHEMA
//                          (Admin Panel Only)
//
// ####################################################################################

// ============================================================================
// ADMIN: Admin Users
// ============================================================================

model AdminUser {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  name         String    @db.VarChar(255)
  avatarUrl    String?   @map("avatar_url") @db.Text
  roleId       String?   @map("role_id") @db.Uuid
  isSuperAdmin Boolean   @default(false) @map("is_super_admin")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  role                  AdminRole?             @relation(fields: [roleId], references: [id], onDelete: SetNull)
  adminUserApplications AdminUserApplication[]
  adminActivityLogs     AdminActivityLog[]
  oauthClients          OAuthClient[]

  @@index([email])
  @@map("admin_users")
  @@schema("admin")
}

// ============================================================================
// ADMIN: Roles & Permissions
// ============================================================================

model AdminRole {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique @db.VarChar(100)
  displayName String?  @map("display_name") @db.VarChar(100)
  description String?  @db.Text
  color       String?  @db.VarChar(20)
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  adminUsers      AdminUser[]
  rolePermissions AdminRolePermission[]

  @@map("admin_roles")
  @@schema("admin")
}

model AdminPermission {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  module      String  @db.VarChar(100)
  action      String  @db.VarChar(100)
  description String? @db.Text

  rolePermissions AdminRolePermission[]

  @@unique([module, action])
  @@map("admin_permissions")
  @@schema("admin")
}

model AdminRolePermission {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  role       AdminRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission AdminPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("admin_role_permissions")
  @@schema("admin")
}

// ============================================================================
// ADMIN: Admin User Applications
// ============================================================================

model AdminUserApplication {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminUserId String   @map("admin_user_id") @db.Uuid
  applicationId String @map("application_id") @db.Uuid
  role        String   @default("admin") @db.VarChar(50)
  permissions Json     @default("[]")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  adminUser   AdminUser   @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([adminUserId, applicationId])
  @@index([adminUserId])
  @@index([applicationId])
  @@map("admin_user_applications")
  @@schema("admin")
}

// ============================================================================
// ADMIN: Activity Log & Audit
// ============================================================================

model AdminActivityLog {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminUserId   String?  @map("admin_user_id") @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  action        String   @db.VarChar(100)
  resourceType  String?  @map("resource_type") @db.VarChar(100)
  resourceId    String?  @map("resource_id") @db.Uuid
  details       Json     @default("{}")
  ipAddress     String?  @map("ip_address") @db.Inet
  userAgent     String?  @map("user_agent") @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  adminUser   AdminUser?   @relation(fields: [adminUserId], references: [id], onDelete: SetNull)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([adminUserId])
  @@index([applicationId])
  @@index([createdAt])
  @@map("admin_activity_log")
  @@schema("admin")
}

model AuditLog {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  actorType     String   @map("actor_type") @db.VarChar(50)
  actorId       String?  @map("actor_id") @db.Uuid
  action        String   @db.VarChar(100)
  tableName     String?  @map("table_name") @db.VarChar(100)
  recordId      String?  @map("record_id") @db.Uuid
  oldValues     Json?    @map("old_values")
  newValues     Json?    @map("new_values")
  ipAddress     String?  @map("ip_address") @db.Inet
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  application Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([applicationId])
  @@index([actorType, actorId])
  @@index([createdAt])
  @@map("audit_logs")
  @@schema("admin")
}

// ============================================================================
// ADMIN: OAuth/SSO Tables
// ============================================================================

model OAuthClient {
  id                        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId                  String   @unique @map("client_id") @db.VarChar(255)
  clientSecretHash          String?  @map("client_secret_hash") @db.VarChar(255)
  clientType                String   @default("public") @map("client_type") @db.VarChar(20)
  name                      String   @db.VarChar(255)
  description               String?  @db.Text
  logoUrl                   String?  @map("logo_url") @db.Text
  homepageUrl               String?  @map("homepage_url") @db.Text
  redirectUris              Json     @default("[]") @map("redirect_uris")
  grantTypes                Json     @default("[]") @map("grant_types")
  allowedScopes             Json     @default("[]") @map("allowed_scopes")
  requirePkce               Boolean  @default(true) @map("require_pkce")
  requireConsent            Boolean  @default(false) @map("require_consent")
  firstParty                Boolean  @default(false) @map("first_party")
  accessTokenLifetime       Int?     @map("access_token_lifetime")
  refreshTokenLifetime      Int?     @map("refresh_token_lifetime")
  idTokenLifetime           Int?     @map("id_token_lifetime")
  privacyPolicyUrl          String?  @map("privacy_policy_url") @db.Text
  termsOfServiceUrl         String?  @map("terms_of_service_url") @db.Text
  isActive                  Boolean  @default(true) @map("is_active")
  createdBy                 String?  @map("created_by") @db.Uuid
  applicationId             String?  @map("application_id") @db.Uuid
  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                 DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  application               Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  creator                   AdminUser?   @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  authorizationCodes        OAuthAuthorizationCode[]
  accessTokens              OAuthAccessToken[]
  refreshTokens             OAuthRefreshToken[]
  userConsents              OAuthUserConsent[]
  auditLog                  OAuthAuditLog[]

  @@index([clientId])
  @@index([isActive])
  @@index([applicationId])
  @@index([createdBy])
  @@map("oauth_clients")
  @@schema("admin")
}

model OAuthAuthorizationCode {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  codeHash      String   @unique @map("code_hash") @db.VarChar(255)
  clientId      String   @map("client_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  redirectUri   String   @map("redirect_uri") @db.Text
  scope         String?  @db.Text
  state         String?  @db.VarChar(255)
  nonce         String?  @db.VarChar(255)
  codeChallenge String?  @map("code_challenge") @db.VarChar(255)
  codeChallengeMethod String? @map("code_challenge_method") @db.VarChar(10)
  sessionId     String?  @map("session_id") @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  usedAt        DateTime? @map("used_at") @db.Timestamptz
  expiresAt     DateTime @map("expires_at") @db.Timestamptz
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  client        OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([codeHash])
  @@index([clientId])
  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("oauth_authorization_codes")
  @@schema("admin")
}

model OAuthAccessToken {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tokenIdHash   String   @unique @map("token_id_hash") @db.VarChar(255)
  clientId      String   @map("client_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  scope         String?  @db.Text
  sessionId     String?  @map("session_id") @db.Uuid
  applicationId String?  @map("application_id") @db.Uuid
  isRevoked     Boolean  @default(false) @map("is_revoked")
  revokedAt     DateTime? @map("revoked_at") @db.Timestamptz
  revokedReason String?  @map("revoked_reason") @db.Text
  expiresAt     DateTime @map("expires_at") @db.Timestamptz
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  client        OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  refreshTokens OAuthRefreshToken[]

  @@index([tokenIdHash])
  @@index([clientId])
  @@index([userId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("oauth_access_tokens")
  @@schema("admin")
}

model OAuthRefreshToken {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tokenHash         String   @unique @map("token_hash") @db.VarChar(255)
  clientId          String   @map("client_id") @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  accessTokenId     String?  @map("access_token_id") @db.Uuid
  scope             String?  @db.Text
  sessionId         String?  @map("session_id") @db.Uuid
  applicationId     String?  @map("application_id") @db.Uuid
  previousTokenId   String?  @map("previous_token_id") @db.Uuid
  rotationCount     Int      @default(0) @map("rotation_count")
  isRevoked         Boolean  @default(false) @map("is_revoked")
  revokedAt         DateTime? @map("revoked_at") @db.Timestamptz
  revokedReason     String?  @map("revoked_reason") @db.Text
  expiresAt         DateTime @map("expires_at") @db.Timestamptz
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  client            OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  accessToken       OAuthAccessToken? @relation("RefreshTokenAccess", fields: [accessTokenId], references: [id], onDelete: SetNull)
  previousRefreshToken OAuthRefreshToken? @relation("RefreshTokenRotation", fields: [previousTokenId], references: [id], onDelete: SetNull)

  @@index([tokenHash])
  @@index([clientId])
  @@index([userId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("oauth_refresh_tokens")
  @@schema("admin")
}

model OAuthUserConsent {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  clientId      String   @map("client_id") @db.Uuid
  grantedScopes Json     @map("granted_scopes")
  applicationId String?  @map("application_id") @db.Uuid
  revokedAt     DateTime? @map("revoked_at") @db.Timestamptz
  expiresAt     DateTime? @map("expires_at") @db.Timestamptz
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  client        OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId, applicationId])
  @@index([userId])
  @@index([clientId])
  @@index([revokedAt])
  @@map("oauth_user_consents")
  @@schema("admin")
}

model OAuthAuditLog {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventType         String   @map("event_type") @db.VarChar(50)
  clientId          String?  @map("client_id") @db.Uuid
  userId            String?  @map("user_id") @db.Uuid
  sessionId         String?  @map("session_id") @db.Uuid
  details           Json     @default("{}")
  ipAddress         String?  @map("ip_address") @db.Inet
  userAgent         String?  @map("user_agent") @db.Text
  success           Boolean  @default(true)
  errorCode         String?  @map("error_code") @db.VarChar(50)
  errorDescription  String?  @map("error_description") @db.Text
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  client            OAuthClient? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([eventType])
  @@index([clientId])
  @@index([userId])
  @@index([createdAt])
  @@map("oauth_audit_log")
  @@schema("admin")
}

model SSOSession {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionIdHash   String   @unique @map("session_id_hash") @db.VarChar(255)
  userId          String   @map("user_id") @db.Uuid
  ipAddress       String?  @map("ip_address") @db.Inet
  userAgent       String?  @map("user_agent") @db.Text
  authTime        DateTime @map("auth_time") @db.Timestamptz
  authMethod      String   @map("auth_method") @db.VarChar(50)
  applicationId   String?  @map("application_id") @db.Uuid
  activeClients   Json     @default("[]") @map("active_clients")
  isActive        Boolean  @default(true) @map("is_active")
  lastActivityAt  DateTime @default(now()) @map("last_activity_at") @db.Timestamptz
  endedAt         DateTime? @map("ended_at") @db.Timestamptz
  expiresAt       DateTime @map("expires_at") @db.Timestamptz
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([sessionIdHash])
  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sso_sessions")
  @@schema("admin")
}
